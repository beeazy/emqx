<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  const statusEl = document.getElementById("status");
  const topicEl = document.getElementById("topicName");
  const messagesEl = document.getElementById("messages");
  const alertsEl = document.getElementById("alerts");

  socket.on("connect", () => {
    statusEl.innerText = "Connected";
    statusEl.className = "status connected";
  });

  socket.on("disconnect", () => {
    statusEl.innerText = "Disconnected";
    statusEl.className = "status disconnected";
  });

  socket.on("mqtt_message", (msg) => {
    let payload;
    try {
      payload = JSON.parse(msg.message);
    } catch (e) {
      payload = null;
    }

    if (topicEl.textContent === "â€“") {
      topicEl.textContent = msg.topic;
    }

    const div = document.createElement("div");
    div.className = "message";

    if (payload && payload.patient) {
      div.innerHTML = `
        <div class="topic">Topic: ${msg.topic}</div>
        <div class="payload">
          <b>Patient:</b> ${payload.patient.name} (ID: ${payload.patient.id}, Age: ${payload.patient.age})<br/>
          <b>Bed:</b> ${payload.bedId} â€” ${payload.patient.location}<br/>
          <b>Weights:</b>
          <ul>
            <li>Head Left: ${payload.weights.head_left} kg</li>
            <li>Head Right: ${payload.weights.head_right} kg</li>
            <li>Foot Left: ${payload.weights.foot_left} kg</li>
            <li>Foot Right: ${payload.weights.foot_right} kg</li>
          </ul>
          <div class="time">Timestamp: ${new Date(payload.timestamp).toLocaleString()}</div>
        </div>
      `;
    } else {
      div.innerHTML = `
        <div class="topic">Topic: ${msg.topic}</div>
        <div class="payload">${msg.message}</div>
        <div class="time">${new Date().toLocaleTimeString()}</div>
      `;
    }

    messagesEl.prepend(div);
  });

  socket.on("nurse_alert", (alert) => {
    const p = document.createElement("p");
    p.className = "alert";
    p.textContent = `ðŸš¨ ${alert.reason} for ${alert.patient.name} (Bed ${alert.patient.bedId}) @ ${new Date(alert.ts).toLocaleTimeString()}`;
    alertsEl.prepend(p);
  });
</script>